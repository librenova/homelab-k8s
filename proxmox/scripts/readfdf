Proxmox Cloud-Init Template Creation Script
ğŸ“Œ Overview
The create_proxmox_template.sh script automates the creation of Cloud-Init templates in Proxmox. It downloads a Cloud-Init image, provisions a VM, configures Cloud-Init support, and converts the VM into a template.

Additionally, it includes pre- and post-creation hooks to ensure smooth execution.

ğŸ›  Features
âœ… Automated Proxmox Template Creation â€“ No manual VM setup required.
âœ… Supports Multiple Operating Systems â€“ Ubuntu, Rocky Linux, Debian, and AlmaLinux.
âœ… Dynamic VM ID Allocation â€“ Avoids conflicts with existing VMs.
âœ… Pre-Creation Hook â€“ Validates system resources and template duplication.
âœ… Post-Creation Hook â€“ Provides instructions for cloning the template.
âœ… Error Handling â€“ Ensures downloads are valid before proceeding.

ğŸ“‚ Folder Structure
bash
Copy
Edit
/var/lib/vz/snippets/
â”‚â”€â”€ create_proxmox_template.sh    # The script for Proxmox Cloud-Init template creation
â”‚â”€â”€ README.md                      # Documentation explaining the script
ğŸ”¹ How It Works
1ï¸âƒ£ OS Selection
The script presents a menu of supported operating systems.
The user selects an OS, and the script fetches the corresponding Cloud-Init image.
2ï¸âƒ£ Find the Next Available VM ID
The script dynamically finds the next available VM ID in Proxmox to prevent conflicts.
3ï¸âƒ£ Download the Cloud-Init Image
The script downloads the Cloud-Init image and verifies its integrity before proceeding.
4ï¸âƒ£ Create a New VM in Proxmox
A new VM is created with allocated CPU, RAM, and networking.
5ï¸âƒ£ Import the Cloud-Init Image
The downloaded Cloud-Init image is imported into Proxmox storage.
6ï¸âƒ£ Configure Cloud-Init Support
The script configures:
Boot disk
Serial console
QEMU guest agent
Cloud-Init support
7ï¸âƒ£ Convert the VM into a Template
The configured VM is converted into a Proxmox template for future cloning.
8ï¸âƒ£ Cleanup
The downloaded Cloud-Init image is removed to save disk space.
ğŸ“œ Pre-Creation Hook
Before creating the template, the script performs pre-checks:

âœ… Ensures at least 10GB free space is available.
âœ… Checks if a template with the same name already exists in Proxmox.
ğŸ”¹ Pre-Creation Hook Code
bash
Copy
Edit
pre_creation_tasks() {
    echo "ğŸ” Checking system requirements..."
    
    # Ensure at least 10GB free space
    FREE_SPACE=$(df -h /var/lib/vz | awk 'NR==2 {print $4}')
    echo "âœ… Free Space: $FREE_SPACE"
    
    # Check if template already exists
    if qm list | grep -q "$TEMPLATE_NAME"; then
        echo "âŒ ERROR: A template with the name '$TEMPLATE_NAME' already exists!"
        exit 1
    fi
}
ğŸ“œ Post-Creation Hook
After the template is created, the script:

âœ… Displays a success message.
âœ… Provides instructions on cloning the template.
ğŸ”¹ Post-Creation Hook Code
bash
Copy
Edit
post_creation_tasks() {
    echo "ğŸ‰ Template Created Successfully!"
    echo "â¡ To clone this template, run:"
    echo "   qm clone $NEXT_VM_ID 200 --name cloned-vm --full true"
}
ğŸš€ Usage Instructions
1ï¸âƒ£ Run the Script
sh
Copy
Edit
bash create_proxmox_template.sh
2ï¸âƒ£ Select an OS
yaml
Copy
Edit
ğŸ“Œ Select an OS for the Proxmox Cloud-Init Template:
1) ubuntu-22.04
2) rocky-8
3) debian-11
4) almalinux-9
#? 2
3ï¸âƒ£ The Script Automates the Following:
âœ… Downloads the Cloud-Init Image
âœ… Creates a Proxmox VM
âœ… Configures Cloud-Init
âœ… Converts the VM into a Template
âœ… Provides instructions for cloning the template

ğŸ”§ Troubleshooting
âŒ ERROR: Failed to Download Cloud-Init Image
âœ” Solution: Ensure the Cloud-Init image URL is correct.
âœ” Test Manually: Try downloading using wget:

sh
Copy
Edit
wget https://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-GenericCloud-Base.latest.x86_64.qcow2
âŒ ERROR: A Template with This Name Already Exists
âœ” Solution: Run qm list to check existing templates:

sh
Copy
Edit
qm list
âœ” Delete the Existing Template:

sh
Copy
Edit
qm destroy <VM_ID>
ğŸ›  Enhancements & Next Steps
âœ¨ Automate VM Cloning â€“ Extend the script to create multiple VMs from the template.
âœ¨ Add Kubernetes Node Provisioning â€“ Automate the setup of Kubernetes Master and Worker nodes.
âœ¨ Multi-Cloud Deployment â€“ Extend the script for AWS, GCP, and Azure.
ğŸ”— Useful Proxmox Commands
List All VMs
sh
Copy
Edit
qm list
Clone a Template to a New VM
sh
Copy
Edit
qm clone 9000 200 --name my-new-vm --full true
Delete a VM
sh
Copy
Edit
qm destroy 200
ğŸ“Œ Conclusion
This script automates the creation of Cloud-Init templates in Proxmox, reducing manual work and ensuring a consistent environment for Kubernetes, CI/CD pipelines, and infrastructure automation.

âœ… Pre-Creation Checks âœ… Cloud-Init Support âœ… Template Creation âœ… Post-Creation Instructions

